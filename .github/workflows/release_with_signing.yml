name: Release (Samsung signing placeholder)

on:
  workflow_dispatch:

permissions:
  contents: write
  packages: write

jobs:
  build-and-sign:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '11'

      - name: Install Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true

      - name: Flutter pub get
        run: flutter pub get

      - name: Check signing secrets
        run: |
          if [ -z "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" ]; then
            echo "Skipping signing: ANDROID_KEYSTORE_BASE64 not set";
            exit 0;
          fi

      - name: Decode keystore
        if: ${{ secrets.ANDROID_KEYSTORE_BASE64 != '' }}
        run: |
          echo "$ANDROID_KEYSTORE_BASE64" | base64 --decode > upload-keystore.jks
          # Create a key.properties file consumed by Gradle
          cat > android/key.properties <<EOF
storeFile=upload-keystore.jks
storePassword=${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
keyAlias=${{ secrets.ANDROID_KEY_ALIAS }}
keyPassword=${{ secrets.ANDROID_KEY_PASSWORD }}
EOF
        env:
          ANDROID_KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}

      - name: Build signed Samsung AAB
        if: ${{ secrets.ANDROID_KEYSTORE_BASE64 != '' }}
        run: |
          # This assumes you have configured gradle signing props via secrets
          flutter build appbundle --flavor samsung -t lib/main.dart --release

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: samsung-signed-aab
          path: build/app/outputs/bundle/**
